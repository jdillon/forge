#!/usr/bin/env bun

/**
 * Forge v2 - Pure Bun/TypeScript Implementation
 *
 * Entry point for forge2 command with Commander.js
 */

import { Command } from 'commander';
import chalk from 'chalk';
import updateNotifier from 'update-notifier';
import { Forge, discoverProject, getProjectRoot } from './lib/core';
import pkg from './package.json' assert { type: 'json' };

// Check for updates (once per day)
updateNotifier({
  pkg,
  updateCheckInterval: 1000 * 60 * 60 * 24
}).notify();

const program = new Command();

program
  .name('forge2')
  .description('Modern CLI framework for deployments')
  .version(pkg.version)
  .option('-r, --root <path>', 'Project root directory')
  .option('-v, --verbose', 'Verbose output')
  .hook('preAction', async (thisCommand) => {
    // This runs before every command
    const options = thisCommand.opts();

    // Store global options for access by commands
    program.globalOptions = options;
  });

// Handle unknown commands by delegating to project config
program.action(async (options, command) => {
  // Get command name from remaining args
  const args = command.args;
  if (args.length === 0) {
    command.help();
    return;
  }

  const commandName = args[0];
  const commandArgs = args.slice(1);

  // Find project root
  let projectRoot = options.root || getProjectRoot();

  if (!projectRoot) {
    projectRoot = await discoverProject();
  }

  if (!projectRoot) {
    console.error(chalk.red('âœ—') + ' ERROR: No .forge2/ directory found\n');
    console.error('Run this command from within a forge project directory,');
    console.error('or set ' + chalk.cyan('FORGE_PROJECT') + ' environment variable,');
    console.error('or use ' + chalk.cyan('--root') + ' flag: ' + chalk.gray('forge2 --root=/path/to/project'));
    process.exit(1);
  }

  // Create forge instance and run
  const forge = new Forge(projectRoot, options);
  await forge.run(commandName, commandArgs);
});

// Parse args
program.parse();
