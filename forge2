#!/usr/bin/env bun

/**
 * Forge v2 - Pure Bun/TypeScript Implementation
 *
 * Entry point for forge2 command with Commander.js
 */

import { Command } from 'commander';
import chalk from 'chalk';
import updateNotifier from 'update-notifier';
import { Forge, discoverProject, getProjectRoot, buildCommanderCommand } from './lib/core';
import pkg from './package.json' assert { type: 'json' };

// Check for updates (once per day)
updateNotifier({
  pkg,
  updateCheckInterval: 1000 * 60 * 60 * 24
}).notify();

const program = new Command();

program
  .name('forge2')
  .description('Modern CLI framework for deployments')
  .version(pkg.version)
  .option('-r, --root <path>', 'Project root directory')
  .option('-v, --verbose', 'Verbose output');

// ============================================================================
// Dynamic Command Registration
// ============================================================================

async function setupCommands() {
  // Find project root
  const globalOpts = program.opts();
  let projectRoot = globalOpts.root || getProjectRoot();

  if (!projectRoot) {
    projectRoot = await discoverProject();
  }

  if (!projectRoot) {
    console.error(chalk.red('✗') + ' ERROR: No .forge2/ directory found\n');
    console.error('Run this command from within a forge project directory,');
    console.error('or set ' + chalk.cyan('FORGE_PROJECT') + ' environment variable,');
    console.error('or use ' + chalk.cyan('--root') + ' flag: ' + chalk.gray('forge2 --root=/path/to/project'));
    process.exit(1);
  }

  // Load project config and auto-discover commands
  const forge = new Forge(projectRoot, globalOpts);
  await forge.loadConfig();

  // Register command groups as subcommands
  for (const [groupName, group] of Object.entries(forge.commandGroups)) {
    // Create group subcommand
    const groupCmd = new Command(groupName);

    // Add each command to the group
    for (const [cmdName, forgeCmd] of Object.entries(group.commands)) {
      const cmd = buildCommanderCommand(cmdName, forgeCmd);
      groupCmd.addCommand(cmd);
    }

    program.addCommand(groupCmd);
  }

  // Parse args
  program.parse();
}

// Run setup
setupCommands().catch(err => {
  console.error(chalk.red('✗ ERROR:'), err.message);
  process.exit(1);
});
