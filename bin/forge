#!/usr/bin/env bash
# IMPORANT: retain compatibility with bash v3 (macOS)
set -euo pipefail

# Detect dev vs installed mode
script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
dev_cli="${script_dir}/../lib/cli.ts"
dev_package="${script_dir}/../package.json"

if [[ -f "${dev_cli}" ]] && [[ -f "${dev_package}" ]]; then
  # Dev mode - running from repository
  forge_cli="${dev_cli}"
  forge_home="${XDG_DATA_HOME:-$HOME/.local/share}/forge"
  node_path="${script_dir}/../node_modules${NODE_PATH:+:$NODE_PATH}"
else
  # Installed mode - use installed version
  forge_home="${XDG_DATA_HOME:-$HOME/.local/share}/forge"
  forge_cli="${forge_home}/node_modules/@planet57/forge/lib/cli.ts"
  node_path="${forge_home}/node_modules${NODE_PATH:+:$NODE_PATH}"
  
  if [[ ! -f "${forge_cli}" ]]; then
    echo "ERROR: Forge not found at ${forge_cli}" >&2
    echo "Run install.sh to reinstall forge" >&2
    exit 1
  fi
fi

# Run forge with proper configuration
run_forge() {
  local restarted="${1:-}"

  # Set restart flag if provided
  if [[ -n "$restarted" ]]; then
    export FORGE_RESTARTED=1
  fi

  export NODE_PATH="${node_path}"

  # Run forge CLI
  bun run "${forge_cli}" "${@:2}"
}

# Run forge and capture exit code
set +e  # Don't exit on non-zero
run_forge "" "$@"
EXIT_CODE=$?
set -e

# Exit code 42 = restart needed (dependencies installed)
# "I checked it very thoroughly, and that quite definitely is the answer."
if [[ $EXIT_CODE -eq 42 ]]; then
  # Re-run with FORGE_RESTARTED=1 to prevent infinite loops
  run_forge "restarted" "$@"
  exit $?
fi

# Normal exit
exit $EXIT_CODE
