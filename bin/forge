#!/usr/bin/env bash
# IMPORANT: retain compatibility with bash v3 (macOS)
set -euo pipefail

# Resolve symlinks to get actual script location
script_path="${BASH_SOURCE[0]}"
while [[ -L "${script_path}" ]]; do
  script_dir="$(cd "$(dirname "${script_path}")" && pwd)"
  script_path="$(readlink "${script_path}")"
  # Handle relative symlinks
  [[ "${script_path}" != /* ]] && script_path="${script_dir}/${script_path}"
done

# Detect dev vs installed mode
script_dir="$(cd "$(dirname "${script_path}")" && pwd)"
dev_cli="${script_dir}/../lib/cli.ts"
dev_package="${script_dir}/../package.json"

# Detect mode and set FORGE_NODE_MODULES if not already set (e.g., by tests)
if [[ -z "${FORGE_NODE_MODULES:-}" ]]; then
  if [[ -f "${dev_cli}" ]] && [[ -f "${dev_package}" ]]; then
    # Dev mode - running from repository
    forge_node_modules="${script_dir}/../node_modules"
  else
    # Installed mode - use installed version
    forge_home="${XDG_DATA_HOME:-$HOME/.local/share}/forge"
    forge_node_modules="${forge_home}/node_modules"
  fi

  export FORGE_NODE_MODULES="${forge_node_modules}"
fi

# Detect CLI location based on mode
if [[ -f "${dev_cli}" ]] && [[ -f "${dev_package}" ]]; then
  # Dev mode
  forge_cli="${dev_cli}"
else
  # Installed mode
  forge_home="${XDG_DATA_HOME:-$HOME/.local/share}/forge"
  forge_cli="${forge_home}/node_modules/@planet57/forge/lib/cli.ts"

  if [[ ! -f "${forge_cli}" ]]; then
    echo "ERROR: Forge not found at ${forge_cli}" >&2
    echo "Run install.sh to reinstall forge" >&2
    exit 1
  fi
fi

# Set NODE_PATH for Bun's runtime module resolution
export NODE_PATH="${FORGE_NODE_MODULES}"

# Run forge with proper configuration
run_forge() {
  local restarted="${1:-}"

  # Set restart flag if provided
  if [[ -n "$restarted" ]]; then
    export FORGE_RESTARTED=1
  fi

  # Run forge CLI (FORGE_NODE_MODULES and NODE_PATH already exported above)
  bun run "${forge_cli}" "${@:2}"
}

# Run forge and capture exit code
set +e  # Don't exit on non-zero
run_forge "" "$@"
EXIT_CODE=$?
set -e

# Exit code 42 = restart needed (dependencies installed)
# "I checked it very thoroughly, and that quite definitely is the answer."
if [[ $EXIT_CODE -eq 42 ]]; then
  # Re-run with FORGE_RESTARTED=1 to prevent infinite loops
  run_forge "restarted" "$@"
  exit $?
fi

# Normal exit
exit $EXIT_CODE
