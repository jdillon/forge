#!/usr/bin/env bash
# IMPORANT: retain compatibility with bash v3 (macOS)
set -euo pipefail

# Resolve symlinks to get actual script location
script_path="${BASH_SOURCE[0]}"
while [[ -L "${script_path}" ]]; do
  script_dir="$(cd "$(dirname "${script_path}")" && pwd)"
  script_path="$(readlink "${script_path}")"
  # Handle relative symlinks
  [[ "${script_path}" != /* ]] && script_path="${script_dir}/${script_path}"
done

# Installed mode only - forge-dev handles dev mode
script_dir="$(cd "$(dirname "${script_path}")" && pwd)"

# Capture user's current working directory (fully resolved)
export FORGE_USER_DIR="$(pwd -P)"

# Set FORGE_NODE_MODULES if not already set (e.g., by tests)
if [[ -z "${FORGE_NODE_MODULES:-}" ]]; then
  forge_home="${XDG_DATA_HOME:-$HOME/.local/share}/forge"
  forge_node_modules="${forge_home}/node_modules"
  export FORGE_NODE_MODULES="${forge_node_modules}"
fi

# Installed mode - use forge-home
forge_home="${XDG_DATA_HOME:-$HOME/.local/share}/forge"
forge_cli="${forge_home}/node_modules/@planet57/forge/lib/cli.ts"

if [[ ! -f "${forge_cli}" ]]; then
  echo "ERROR: Forge not found at ${forge_cli}" >&2
  echo "Run install.sh to reinstall forge" >&2
  exit 1
fi

# Set NODE_PATH for Bun's runtime module resolution
export NODE_PATH="${FORGE_NODE_MODULES}"

# Run forge with proper configuration
run_forge() {
  local restarted="${1:-}"

  # Set restart flag if provided
  if [[ -n "$restarted" ]]; then
    export FORGE_RESTARTED=1
  fi

  # Use --cwd to set Bun's working directory to forge_home
  # This makes Bun find the config files (bunfig.toml, tsconfig.json) in forge_home
  # User's actual cwd remains unchanged in FORGE_USER_DIR
  bun --cwd="${forge_home}" run "${forge_cli}" "${@:2}"
}

# Run forge and capture exit code
set +e  # Don't exit on non-zero
run_forge "" "$@"
EXIT_CODE=$?
set -e

# Exit code 42 = restart needed (dependencies installed)
# "I checked it very thoroughly, and that quite definitely is the answer."
if [[ $EXIT_CODE -eq 42 ]]; then
  # Re-run with FORGE_RESTARTED=1 to prevent infinite loops
  run_forge "restarted" "$@"
  exit $?
fi

# Normal exit
exit $EXIT_CODE
