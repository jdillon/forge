#!/usr/bin/env bash
# Forge bootstrap script - delegates to installed version
set -euo pipefail

FORGE_SHARE="${XDG_DATA_HOME:-$HOME/.local/share}/forge"
FORGE_CLI="${FORGE_SHARE}/node_modules/@planet57/forge/lib/cli.ts"

if [[ ! -f "${FORGE_CLI}" ]]; then
  echo "ERROR: Forge not found at ${FORGE_CLI}" >&2
  echo "Run install.sh to reinstall forge" >&2
  exit 1
fi

# Forge home - where dependencies are managed
FORGE_HOME="${XDG_DATA_HOME:-$HOME/.local/share}/forge"

# Run forge with proper bun configuration
# Sets up:
#   - NODE_PATH for module resolution from forge home
#   - Optional FORGE_RESTARTED flag for dependency restart
run_forge() {
  local restarted="${1:-}"

  # Set NODE_PATH to include forge home node_modules (enables shared dependencies)
  export NODE_PATH="${FORGE_HOME}/node_modules${NODE_PATH:+:$NODE_PATH}"

  # Set restart flag if provided
  if [[ -n "$restarted" ]]; then
    export FORGE_RESTARTED=1
  fi

  # Run forge CLI with NODE_PATH set for shared dependency resolution
  bun run "${FORGE_CLI}" "${@:2}"
}

# Run forge and capture exit code
set +e  # Don't exit on non-zero
run_forge "" "$@"
EXIT_CODE=$?
set -e

# Exit code 42 = restart needed (dependencies installed)
if [[ $EXIT_CODE -eq 42 ]]; then
  # Re-run with FORGE_RESTARTED=1 to prevent infinite loops
  run_forge "restarted" "$@"
  exit $?
fi

# Normal exit
exit $EXIT_CODE
