#!/usr/bin/env bash
# bin/forge-dev - Development mode bootstrap
#
# Uses local code from lib/ with isolated dev-home for fast iteration.
# This prevents dev work from polluting your real forge-home installation.
#
# Usage:
#   ./bin/forge-dev [command] [args...]
#   alias forge-dev='./bin/forge-dev'  # For convenience
#
set -euo pipefail

# Resolve script location (follows symlinks)
script_path="${BASH_SOURCE[0]}"
while [ -L "$script_path" ]; do
  script_dir="$(cd -P "$(dirname "$script_path")" && pwd)"
  script_path="$(readlink "$script_path")"
  [[ $script_path != /* ]] && script_path="$script_dir/$script_path"
done
script_dir="$(cd -P "$(dirname "$script_path")" && pwd)"
project_root="$(cd -P "${script_dir}/.." && pwd)"

# Dev mode: use local code with isolated dev-home
export XDG_DATA_HOME="${project_root}/dev-home"
export FORGE_NODE_MODULES="${XDG_DATA_HOME}/forge/node_modules"
export NODE_PATH="${FORGE_NODE_MODULES}"

# Ensure dev-home forge structure exists with tsconfig
forge_home="${XDG_DATA_HOME}/forge"
forge_tsconfig="${forge_home}/tsconfig.json"

if [[ ! -f "${forge_tsconfig}" ]]; then
  mkdir -p "${forge_home}"
  cat > "${forge_tsconfig}" << 'EOF'
{
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
    }
  }
}
EOF
fi

# Run local CLI directly with tsconfig override for module resolution
exec bun --tsconfig-override="${forge_tsconfig}" run "${project_root}/lib/cli.ts" "$@"
