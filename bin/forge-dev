#!/usr/bin/env bash
# bin/forge-dev - Development mode bootstrap
#
# Uses local code from lib/ with isolated dev-home for fast iteration.
# This prevents dev work from polluting your real forge-home installation.
#
# Simulates the installed setup: creates package.json, tsconfig.json, and bunfig.toml
# in dev-home/forge/ just like bin/install.sh does for real installations.
#
# Usage:
#   ./bin/forge-dev [command] [args...]
#   alias forge-dev='./bin/forge-dev'  # For convenience
#
set -euo pipefail

# Resolve script location (follows symlinks)
script_path="${BASH_SOURCE[0]}"
while [ -L "$script_path" ]; do
  script_dir="$(cd -P "$(dirname "$script_path")" && pwd)"
  script_path="$(readlink "$script_path")"
  [[ $script_path != /* ]] && script_path="$script_dir/$script_path"
done
script_dir="$(cd -P "$(dirname "$script_path")" && pwd)"
project_root="$(cd -P "${script_dir}/.." && pwd)"

# Capture user's current working directory (fully resolved)
export FORGE_USER_DIR="$(pwd -P)"

# Dev mode: use local code with isolated dev-home
export XDG_DATA_HOME="${project_root}/dev-home"
forge_home="${XDG_DATA_HOME}/forge"
export FORGE_NODE_MODULES="${forge_home}/node_modules"
export NODE_PATH="${FORGE_NODE_MODULES}"

# Ensure dev-home forge structure exists
mkdir -p "${forge_home}"

# Create package.json (simulates what install.sh does) - only if it doesn't exist
if [[ ! -f "${forge_home}/package.json" ]]; then
  cat > "${forge_home}/package.json" << EOF
{
  "name": "forge-dev-home",
  "version": "1.0.0",
  "private": true,
  "dependencies": {
    "@planet57/forge": "file:${project_root}"
  }
}
EOF
fi

# Create tsconfig.json (simulates what install.sh does) - only if it doesn't exist
if [[ ! -f "${forge_home}/tsconfig.json" ]]; then
  cat > "${forge_home}/tsconfig.json" << 'EOF'
{
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@forge/*": ["./node_modules/@planet57/forge/lib/*"]
    }
  }
}
EOF
fi

# Create bunfig.toml (simulates what install.sh does) - only if it doesn't exist
if [[ ! -f "${forge_home}/bunfig.toml" ]]; then
  cat > "${forge_home}/bunfig.toml" << 'EOF'
[install]
exact = true
dev = false
peer = true
optional = false
auto = "disable"
EOF
fi

# Run forge with proper configuration
run_forge() {
  local restarted="${1:-}"

  # Set restart flag if provided
  if [[ -n "$restarted" ]]; then
    export FORGE_RESTARTED=1
  fi

  # Use --cwd to set Bun's working directory to forge_home
  # This makes Bun find the config files (bunfig.toml, tsconfig.json) we created above
  # User's actual cwd remains unchanged in FORGE_USER_DIR
  bun --cwd="${forge_home}" run "${project_root}/lib/cli.ts" "${@:2}"
}

# Run forge and capture exit code
set +e  # Don't exit on non-zero
run_forge "" "$@"
EXIT_CODE=$?
set -e

# Exit code 42 = restart needed (dependencies installed)
# "I checked it very thoroughly, and that quite definitely is the answer."
if [[ $EXIT_CODE -eq 42 ]]; then
  # Re-run with FORGE_RESTARTED=1 to prevent infinite loops
  run_forge "restarted" "$@"
  exit $?
fi

# Normal exit
exit $EXIT_CODE
