#!/usr/bin/env bash
# bin/forge-dev - Development mode bootstrap
#
# Uses packaged tarball with isolated dev-home for development.
# Smart rebuild: only packs/installs when source files change.
# Avoids recursive directory hell by using tarball instead of directory reference.
#
# Usage:
#   ./bin/forge-dev [command] [args...]
#   FORGE_REBUILD=1 ./bin/forge-dev [command]  # Force rebuild
#
set -euo pipefail

# Resolve script location (follows symlinks)
script_path="${BASH_SOURCE[0]}"
while [ -L "$script_path" ]; do
  script_dir="$(cd -P "$(dirname "$script_path")" && pwd)"
  script_path="$(readlink "$script_path")"
  [[ $script_path != /* ]] && script_path="$script_dir/$script_path"
done
script_dir="$(cd -P "$(dirname "$script_path")" && pwd)"
project_root="$(cd -P "${script_dir}/.." && pwd)"

# Dev mode: use packaged tarball with isolated dev-home
export FORGE_HOME="${project_root}/dev-home/forge"
export NODE_PATH="${FORGE_HOME}/node_modules"

# Ensure dev-home forge structure exists
mkdir -p "${FORGE_HOME}"

#
# Checksum-based change detection
#

compute_checksum() {
  (
    cd "${project_root}"
    # Checksum lib/**, package.json, tsconfig.json, bunfig.toml
    (find lib -type f -exec sha256sum {} \; && \
    sha256sum package.json tsconfig.json bunfig.toml 2>/dev/null) | \
    sort | sha256sum | cut -d' ' -f1
  )
}

needs_rebuild() {
  local checksum_file="${FORGE_HOME}/.forge-checksum"
  local current=$(compute_checksum)
  local previous=$(cat "$checksum_file" 2>/dev/null || echo "")

  [[ "$current" != "$previous" ]]
}

#
# Rebuild and install
#

rebuild_and_install() {
  echo "" >&2
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" >&2
  echo "  Rebuilding forge (source files changed)" >&2
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" >&2

  echo "  → Clearing Bun cache..." >&2
  # Clear Bun's cache to avoid stale module issues
  bun pm cache rm

  echo "  → Building tarball..." >&2
  # Clean old tarballs to avoid confusion
  local tarball="${project_root}/build/planet57-forge-dev.tgz"
  rm -f "${tarball}"
  (
    cd "${project_root}"
    bun pm pack --filename "${tarball}"
  )

  if [[ ! -f "$tarball" ]]; then
    echo "ERROR: Expected tarball not found: $tarball" >&2
    exit 1
  fi

  # Create package.json with tarball reference
  cat > "${FORGE_HOME}/package.json" << EOF
{
  "name": "forge-dev-home",
  "version": "1.0.0",
  "private": true,
  "dependencies": {
    "@planet57/forge": "file:${tarball}"
  }
}
EOF

  # Create tsconfig.json (simulates what install.sh does) - only if it doesn't exist
  if [[ ! -f "${FORGE_HOME}/tsconfig.json" ]]; then
    cat > "${FORGE_HOME}/tsconfig.json" << 'EOF'
{
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@forge/*": ["./node_modules/@planet57/forge/lib/*"]
    }
  }
}
EOF
  fi

  # Create bunfig.toml (simulates what install.sh does) - only if it doesn't exist
  if [[ ! -f "${FORGE_HOME}/bunfig.toml" ]]; then
    cat > "${FORGE_HOME}/bunfig.toml" << 'EOF'
[install]
exact = true
dev = false
peer = true
optional = false
auto = "disable"
EOF
  fi

  # Install/update @planet57/forge in dev-home
  echo "  → Installing to dev-home..." >&2

  # Purge old installed package to force fresh install
  rm -rf "${FORGE_HOME}/node_modules/@planet57/forge"
  (
    cd "${FORGE_HOME}"
    bun install
  )

  # Save new checksum
  compute_checksum > "${FORGE_HOME}/.forge-checksum"

  echo "  ✓ Rebuild complete" >&2
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" >&2
  echo "" >&2
}

#
# Run forge with restart handling
#

run_forge() {
  local restarted="${1:-}"

  # Set restart flag if provided
  if [[ -n "$restarted" ]]; then
    export FORGE_RESTARTED=1
  fi

  # Find the CLI entry point in installed package
  local node_modules="${FORGE_HOME}/node_modules"
  local cli_path="${node_modules}/@planet57/forge/lib/cli.ts"
  export NODE_PATH="${node_modules}"

  if [[ ! -f "$cli_path" ]]; then
    echo "ERROR: CLI not found at $cli_path" >&2
    exit 1
  fi

  # Use --preserve-symlinks to prevent Bun from resolving through symlinks
  # This allows user commands symlinked into node_modules to resolve forge correctly
  bun run --preserve-symlinks "${cli_path}" "${@:2}"
}

#
# Main
#

# Check if rebuild needed (or forced via FORGE_REBUILD=1)
if [[ "${FORGE_REBUILD:-}" == "1" ]] || needs_rebuild; then
  rebuild_and_install
fi

# Run forge and capture exit code
set +e  # Don't exit on non-zero
run_forge "" "$@"
EXIT_CODE=$?
set -e

# Exit code 42 = restart needed (dependencies installed)
# "I checked it very thoroughly, and that quite definitely is the answer."
if [[ $EXIT_CODE -eq 42 ]]; then
  # Re-run with FORGE_RESTARTED=1 to prevent infinite loops
  run_forge "restarted" "$@"
  exit $?
fi

# Normal exit
exit $EXIT_CODE
